2015, 10/1 Update

Slack上のメッセージを取得したいときのTipsやメモ。
ここではReal Time じゃない方のAPIについて。

jsonのフォーマットが統一されておらず参照しづらいので、どういうフォーマットになっていいるのか調査してみました。		

# 検証条件
自社Slack randomチャンネル
2014年4月〜2015年9月の期間中にポストされたメッセージを見てみた。

# メッセージのフォーマットについて
最低限、以下の3つの情報はないと話にならないと思われる。

- 時刻
- ユーザ名(またはID)
- POSTしたテキスト

基本的には

```json
{
	"ts": "timestamp(float)",
	"user": "user_id(string)",
	"text": "text(string)",
	"type": "type(string)"
}
```

こういうフォーマットになっている。あとは _subtype_ 属性があったりなかったり。
_type_ 属性は _"message"_ 以外の値がなかった。

で、トップから見える要素を見ていると次のような結果が出た。

1. 時刻 _ts_ と テキスト _text_ は必ずある
2. ユーザを参照する属性名が統一されていない。
3. トップレベルからはユーザ情報を参照できない場合さえある

# ユーザIDの参照方法について
基本的には _"user"_ を参照すればIDを取得できる。

_user_ での参照ができなかったポストは以下のパターン:

1. botによるポスト
2. _subtype_ が _"file_share"_ の場合

botの場合でも _"user"_ で参照できる場合はあるので、botによるポストが全て _user_ 属性を持たないわけではない模様。
仕様の変更によるものか、それとも何がしかの条件でそうなってるのか。。。

## _subtype_ が _"bot_message"_ の場合

## _subtype_ が _"file_share"_ の場合
_subtype_ が _"file_share"_ のときは画像のアップロードが行われた場合が該当。
ただし、アップロードが取り消された場合には次のようなjsonが返るのでユーザを参照することは不可能。

```json
 {u'file': None,
  u'subtype': u'file_share',
  u'text': u'A file was shared',
  u'ts': 1423224740.000374,
  u'type': u'message',
  u'upload': False}
```	

この場合はおとなしくスルーするぐらいしか手がないと思われる。それ以外であれば _username_ 属性を参照すればユーザのIDを見ることができる。
